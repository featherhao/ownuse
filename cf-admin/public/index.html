<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TVBox/MoonTV 链接库</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #f6f7f9; }
  header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #fff; border-bottom: 1px solid #edf0f2; }
  h1 { margin: 0; font-size: 20px; font-weight: 600; }
  .wrap { max-width: 900px; margin: 24px auto; background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; text-align: left; }
  th { background: #f8f9fa; font-weight: 600; }
  button { padding: 6px 10px; background: #1677ff; color: #fff; border: 0; border-radius: 8px; cursor: pointer; font-size: 13px; }
  .btn-danger { background: #e5484d; }
  .btn-secondary { background: #6c757d; }
  .msg { color: #c00; min-height: 20px; margin-bottom: 12px; }
  .loading { text-align: center; color: #666; padding: 20px; }
  .empty { text-align: center; color: #999; padding: 40px; }
</style>
</head>
<body>
  <header>
    <h1>TVBox/MoonTV 链接库</h1>
    <div>
      <button id="btnRefresh" onclick="loadLinks()">刷新</button>
      <button id="btnManage" onclick="showLogin()">管理</button>
    </div>
  </header>

  <div class="wrap">
    <div class="msg" id="msg"></div>
    <div id="content">
      <div class="loading">正在加载链接...</div>
    </div>
  </div>

  <!-- 登录弹窗 -->
  <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 24px; border-radius: 10px; width: 320px;">
      <h3 style="margin: 0 0 16px;">管理员登录</h3>
      <form id="loginForm">
        <label style="display: block; margin: 8px 0 4px;">用户名</label>
        <input id="username" name="username" style="width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #d0d7de; border-radius: 6px; margin-bottom: 12px;" required>
        <label style="display: block; margin: 8px 0 4px;">密码</label>
        <input id="password" name="password" type="password" style="width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #d0d7de; border-radius: 6px; margin-bottom: 16px;" required>
        <div style="display: flex; gap: 8px;">
          <button type="submit" style="flex: 1;">登录</button>
          <button type="button" onclick="hideLogin()" class="btn-secondary">取消</button>
        </div>
        <div class="msg" id="loginMsg"></div>
      </form>
    </div>
  </div>

<script>
let isAdmin = false;

async function loadLinks() {
  const msg = document.getElementById('msg');
  const content = document.getElementById('content');
  msg.textContent = '';
  content.innerHTML = '<div class="loading">正在加载链接...</div>';
  
  try {
    const r = await fetch('/api/links');
    const data = await r.json();
    const site = data.api_site || {};
    const keys = Object.keys(site);
    
    if (keys.length === 0) {
      content.innerHTML = '<div class="empty">暂无链接</div>';
      return;
    }
    
    let html = '<table><thead><tr><th>名称</th><th>API 地址</th>';
    if (isAdmin) html += '<th>操作</th>';
    html += '</tr></thead><tbody>';
    
    keys.forEach(k => {
      const item = site[k];
      html += '<tr>';
      html += '<td>' + escapeHtml(item.name || k) + '</td>';
      html += '<td><a href="' + escapeAttr(item.api || '') + '" target="_blank">' + escapeHtml(item.api || '') + '</a></td>';
      if (isAdmin) {
        html += '<td>';
        html += '<button onclick="editLink(\'' + escapeJs(k) + '\', \'' + escapeJs(item.name || '') + '\', \'' + escapeJs(item.api || '') + '\')">编辑</button> ';
        html += '<button class="btn-danger" onclick="deleteLink(\'' + escapeJs(k) + '\')">删除</button>';
        html += '</td>';
      }
      html += '</tr>';
    });
    
    html += '</tbody></table>';
    content.innerHTML = html;
  } catch (e) {
    content.innerHTML = '<div class="empty">加载失败：' + escapeHtml(e.message) + '</div>';
  }
}

async function checkAdminStatus() {
  try {
    const r = await fetch('/api/links', { method: 'HEAD' });
    isAdmin = r.ok;
    document.getElementById('btnManage').textContent = isAdmin ? '管理' : '管理';
  } catch (_) {
    isAdmin = false;
  }
}

function showLogin() {
  if (isAdmin) {
    location.href = '/admin.html';
    return;
  }
  document.getElementById('loginModal').style.display = 'block';
  document.getElementById('username').focus();
}

function hideLogin() {
  document.getElementById('loginModal').style.display = 'none';
  document.getElementById('loginForm').reset();
  document.getElementById('loginMsg').textContent = '';
}

document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = e.target.querySelector('button[type="submit"]');
  const msg = document.getElementById('loginMsg');
  msg.textContent = '';
  btn.disabled = true;
  
  try {
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({
        username: document.getElementById('username').value.trim(),
        password: document.getElementById('password').value
      })
    });
    if (res.ok) {
      isAdmin = true;
      hideLogin();
      loadLinks();
    } else {
      const txt = await res.text();
      msg.textContent = txt || '登录失败';
    }
  } catch (e) {
    msg.textContent = '网络错误：' + e.message;
  } finally {
    btn.disabled = false;
  }
});

function editLink(key, name, api) {
  const newName = prompt('名称:', name);
  if (newName === null) return;
  const newApi = prompt('API 地址:', api);
  if (newApi === null) return;
  
  updateLink(key, newName, newApi);
}

async function updateLink(key, name, api) {
  if (!name || !api) {
    alert('名称和 API 地址不能为空');
    return;
  }
  
  try {
    const r = await fetch('/api/links/' + encodeURIComponent(key), {
      method: 'PUT',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ name, api })
    });
    if (!r.ok) {
      const txt = await r.text();
      alert(txt || '更新失败');
      return;
    }
    loadLinks();
  } catch (e) {
    alert('更新失败：' + e.message);
  }
}

async function deleteLink(key) {
  if (!confirm('确定删除 ' + key + ' 吗？')) return;
  
  try {
    const r = await fetch('/api/links/' + encodeURIComponent(key), { method: 'DELETE' });
    if (!r.ok) {
      const txt = await r.text();
      alert(txt || '删除失败');
      return;
    }
    loadLinks();
  } catch (e) {
    alert('删除失败：' + e.message);
  }
}

function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
function escapeAttr(s) { return escapeHtml(s).replace(/"/g, '&quot;'); }
function escapeJs(s) { return String(s || '').replace(/[\\'"\n\r]/g, m => ({'\\':'\\\\','\'':'\\\'','\"':'\\\"','\n':'\\n','\r':'\\r'}[m])); }

// 初始化
checkAdminStatus();
loadLinks();
</script>
</body>
</html>


